<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Trap Lab ‚Äî glass edition (trap / drill / lo‚Äëfi / house)</title>
<meta name="description" content="Tap the glass circle to generate beats. Apple‚Äëstyle UI. Genres: Trap, Drill, Lo‚Äëfi, House. Tweak by tapping circle edges. Improved music theory melodies. Download WAV ‚Äî all in your browser." />
<style>
  :root{
    --bg:#f3f5f9; --ink:#0b1220; --muted:#5f6b85; --line:#e5e9f2;
    --glass:rgba(255,255,255,0.55); --glass-line:rgba(255,255,255,0.8);
    --accent:#1b6aff; --ok:#1db954; --warn:#f59e0b; --bad:#ef4444;
  }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,#f7f9fc,#ecf1f8);color:var(--ink);font:16px/1.45 ui-sans-serif,system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial}
  header{position:sticky;top:0;z-index:10;background:rgba(247,249,252,.8);backdrop-filter:saturate(140%) blur(10px);border-bottom:1px solid var(--line)}
  .wrap{max-width:980px;margin:0 auto;padding:1rem}
  h1{margin:.2rem 0 .2rem;font-size:1.08rem}
  .sub{color:var(--muted)}
  main{max-width:980px;margin:0 auto;padding:1rem;display:grid;gap:1rem}
  .card{background:rgba(255,255,255,.66);backdrop-filter:blur(10px) saturate(140%);border:1px solid var(--line);border-radius:16px;padding:1rem}

  /* Glass circle */
  .stage{display:grid;place-items:center;min-height:360px}
  .circle{--sz:min(84vw,560px);width:var(--sz);height:var(--sz);position:relative;border-radius:50%;
    background:radial-gradient(180px 140px at 60% 30%, rgba(255,255,255,.7), rgba(255,255,255,.3) 40%, rgba(255,255,255,.18) 60%, rgba(255,255,255,.28));
    border:1px solid var(--glass-line); box-shadow:inset 0 0 60px rgba(255,255,255,.35), 0 30px 80px rgba(17,32,66,.15);
  }
  #viz{position:absolute;inset:7%;width:86%;height:86%;pointer-events:none}
  .ring{position:absolute;inset:10%;border-radius:50%;border:1px dashed #cfd8ea}
  .pulse{position:absolute;inset:0;border-radius:50%;filter:blur(18px);opacity:.25;animation:pulse 2.6s ease-in-out infinite}
  @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(27,106,255,.18)}70%{box-shadow:0 0 0 32px rgba(27,106,255,0)}100%{box-shadow:0 0 0 0 rgba(27,106,255,0)}}
  .center{position:absolute;inset:22%;border-radius:50%;display:grid;place-items:center;background:linear-gradient(180deg,rgba(255,255,255,.85),rgba(255,255,255,.55));border:1px solid var(--glass-line)}
  .center button{all:unset;display:grid;place-items:center;width:150px;height:150px;border-radius:50%;
    background:linear-gradient(180deg,#ffffff,#f2f6ff);border:1px solid #e7ecf7;cursor:pointer;box-shadow:0 10px 25px rgba(20,37,79,.15)}
  .center button:active{transform:scale(.98)}
  .btnLabel{font-weight:700}

  /* Edge controls (tap the circle sides) */
  .edge{position:absolute;width:72px;height:72px;border-radius:50%;display:grid;place-items:center;background:var(--glass);backdrop-filter:blur(12px);
    border:1px solid var(--glass-line); box-shadow:0 8px 20px rgba(17,32,66,.12); cursor:pointer; user-select:none}
  .edge small{color:var(--muted);font-size:.72rem}
  .edge:active{transform:scale(.98)}
  .edge.top{left:50%;top:-12px;transform:translate(-50%,0)}
  .edge.right{right:-12px;top:50%;transform:translate(0,-50%)}
  .edge.bottom{left:50%;bottom:-12px;transform:translate(-50%,0)}
  .edge.left{left:-12px;top:50%;transform:translate(0,-50%)}

  .pill{display:inline-flex;align-items:center;gap:.35rem;border:1px solid #d7deed;background:#fff;padding:.25rem .6rem;border-radius:999px;font-size:.85rem}
  .ok{color:var(--ok)}.warn{color:var(--warn)}.bad{color:var(--bad)}
  .footer{opacity:.75;font-size:.9rem}

  /* Popovers */
  .pop{position:fixed;inset:auto 0 0 0;margin:auto;max-width:520px;background:#fff;border:1px solid var(--line);border-radius:16px;box-shadow:0 30px 80px rgba(17,32,66,.18);padding:12px;display:none}
  .pop.show{display:block}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:.6rem}
  @media (max-width:700px){.row{grid-template-columns:1fr}}
  .chip{display:flex;align-items:center;justify-content:space-between;border:1px solid #e1e7f3;background:#f9fbff;border-radius:12px;padding:.5rem .65rem}
  .chip input[type=range]{width:140px}
  .chip select{background:transparent;color:var(--ink);border:0;outline:0}

  /* Audio overlay for iOS */
  .overlay{position:fixed;inset:0;display:none;place-items:center;background:rgba(255,255,255,.7);backdrop-filter:blur(8px)}
  .overlay.show{display:grid}
  .overlay button{all:unset;background:#fff;border:1px solid #e7ecf7;border-radius:14px;padding:12px 18px;box-shadow:0 10px 25px rgba(20,37,79,.12);cursor:pointer}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>üéõÔ∏è Trap Lab ‚Äî glass</h1>
    <div class="sub">Tap the circle to generate. Genres: Trap / Drill / Lo‚Äëfi / House. Tap circle edges to adjust. Improved theory‚Äëdriven melodies. Download WAV.</div>
  </div>
</header>

<main>
  <section class="card stage">
    <div class="circle" id="circle">
      <canvas id="viz"></canvas>
      <div class="pulse"></div>
      <div class="ring"></div>
      <div class="center">
        <button id="btnGen">
          <div class="btnLabel">Generate</div>
          <div class="sub" id="genHint">tap to compose</div>
        </button>
      </div>
      <!-- Edge controls -->
      <div class="edge top" id="edgeGenre"><div>Genre</div><small id="genreVal">Trap</small></div>
      <div class="edge right" id="edgeTempo"><div>BPM</div><small><span id="bpmVal">140</span></small></div>
      <div class="edge bottom" id="edgeFX"><div>FX</div><small>rev/dist</small></div>
      <div class="edge left" id="edgeFeel"><div>Feel</div><small id="feelVal">1√ó</small></div>
    </div>

    <div style="display:flex;gap:.5rem;justify-content:center;margin-top:.8rem;flex-wrap:wrap">
      <button id="btnPlay" disabled>‚ñ∂ Play</button>
      <button id="btnStop" disabled>‚ñ† Stop</button>
      <button id="btnRender" disabled>‚¨á Download WAV</button>
      <span id="status" class="pill">Ready</span>
    </div>
  </section>

  <section class="card footer">
    <strong>Tip:</strong> On iPhone, you may need to tap once to enable audio. Rendering to WAV uses offline synthesis and mirrors your swing/FX.
  </section>
</main>

<!-- Popovers -->
<div class="pop" id="popTempo">
  <div class="chip">BPM <input id="bpm" type="range" min="90" max="180" value="140"></div>
  <div class="chip">Swing <input id="swing" type="range" min="0" max="60" value="0"></div>
  <div style="display:flex;justify-content:flex-end;gap:.5rem;margin-top:.6rem"><button id="closeTempo">Done</button></div>
</div>
<div class="pop" id="popGenre">
  <div class="chip">Genre
    <select id="genre">
      <option value="trap" selected>Trap</option>
      <option value="drill">Drill</option>
      <option value="lofi">Lo‚Äëfi Trap</option>
      <option value="house">House</option>
    </select>
  </div>
  <div class="chip">Influence
    <select id="influence">
      <option value="classic" selected>Classic</option>
      <option value="dark">Dark</option>
      <option value="spacey">Spacey</option>
      <option value="club">Club</option>
    </select>
  </div>
  <div style="display:flex;justify-content:flex-end;gap:.5rem;margin-top:.6rem"><button id="closeGenre">Done</button></div>
</div>
<div class="pop" id="popFX">
  <div class="chip">Reverb <input id="reverb" type="range" min="0" max="100" value="22"></div>
  <div class="chip">Distortion <input id="dist" type="range" min="0" max="100" value="12"></div>
  <div style="display:flex;justify-content:flex-end;gap:.5rem;margin-top:.6rem"><button id="closeFX">Done</button></div>
</div>
<div class="pop" id="popFeel">
  <div class="chip">Speed
    <select id="speed">
      <option value="1x" selected>1√ó</option>
      <option value="half">Half‚Äëtime</option>
      <option value="triplet">Triplet</option>
    </select>
  </div>
  <div style="display:flex;justify-content:flex-end;gap:.5rem;margin-top:.6rem"><button id="closeFeel">Done</button></div>
</div>

<div class="overlay" id="audioOverlay"><button id="enableAudioBtn">Tap to Enable Audio</button></div>

<script>
// ---------- Utility ----------
const $ = s=> document.querySelector(s);
const choice = a => a[Math.floor(Math.random()*a.length)];
const rnd = (a,b)=> a + Math.random()*(b-a);

// ---------- State ----------
let audio=null, master=null, analyser=null;
let bus=null, dryGain=null, revGain=null, revConvolver=null, distWS=null;
let nowPlaying=false, scheduleTimer=null, pattern=null; let seed=Math.random()*1e9|0;

const UI = {
  btnGen: $('#btnGen'), btnPlay: $('#btnPlay'), btnStop: $('#btnStop'), btnRender: $('#btnRender'), status: $('#status'),
  // edge values
  genreVal: $('#genreVal'), bpmVal: $('#bpmVal'), feelVal: $('#feelVal'),
  // popover controls
  bpm: $('#bpm'), swing: $('#swing'), genre: $('#genre'), influence: $('#influence'), speed: $('#speed'), reverb: $('#reverb'), dist: $('#dist'),
  // popovers
  popTempo: $('#popTempo'), popGenre: $('#popGenre'), popFX: $('#popFX'), popFeel: $('#popFeel'),
  overlay: $('#audioOverlay'), enableAudioBtn: $('#enableAudioBtn')
};

// ---------- Mobile audio unlock ----------
function ensureAudio(){
  if(audio) return audio;
  audio = new (window.AudioContext || window.webkitAudioContext)();
  if(audio.state === 'suspended'){ UI.overlay.classList.add('show'); }
  // FX graph
  bus = audio.createGain(); bus.gain.value = 1.0;
  distWS = audio.createWaveShaper(); distWS.curve = distCurve(0.12); distWS.oversample='4x';
  dryGain = audio.createGain(); dryGain.gain.value = 0.9;
  revConvolver = audio.createConvolver(); revConvolver.buffer = makeImpulse(audio, 2.2, 2.5);
  revGain = audio.createGain(); revGain.gain.value = 0.22;
  master = audio.createGain(); master.gain.value = 0.9;
  analyser = audio.createAnalyser(); analyser.fftSize = 256;
  bus.connect(distWS); distWS.connect(dryGain); dryGain.connect(master);
  bus.connect(revConvolver); revConvolver.connect(revGain); revGain.connect(master);
  master.connect(audio.destination); master.connect(analyser);
  setEffectsFromUI(); startViz();
  return audio;
}
UI.enableAudioBtn.addEventListener('click', async ()=>{ try{ ensureAudio(); await audio.resume(); UI.overlay.classList.remove('show'); }catch(e){ console.error(e);} });
// also try resuming on any touch/click within the circle
$('#circle').addEventListener('pointerdown', async ()=>{ if(!audio) return; if(audio.state==='suspended'){ try{ await audio.resume(); UI.overlay.classList.remove('show'); }catch(e){} }});

// ---------- Edge control handlers ----------
function showPop(el){ el.classList.add('show'); }
function hidePop(el){ el.classList.remove('show'); }
$('#edgeTempo').addEventListener('click', ()=> showPop(UI.popTempo));
$('#closeTempo').addEventListener('click', ()=> hidePop(UI.popTempo));
$('#edgeGenre').addEventListener('click', ()=> showPop(UI.popGenre));
$('#closeGenre').addEventListener('click', ()=> hidePop(UI.popGenre));
$('#edgeFX').addEventListener('click', ()=> showPop(UI.popFX));
$('#closeFX').addEventListener('click', ()=> hidePop(UI.popFX));
$('#edgeFeel').addEventListener('click', ()=> showPop(UI.popFeel));
$('#closeFeel').addEventListener('click', ()=> hidePop(UI.popFeel));

UI.bpm.addEventListener('input', ()=>{ UI.bpmVal.textContent = UI.bpm.value; });
UI.swing.addEventListener('input', ()=>{});
UI.genre.addEventListener('change', ()=>{ UI.genreVal.textContent = UI.genre.options[UI.genre.selectedIndex].text; /* auto bpm nudge for house */ if(UI.genre.value==='house' && parseInt(UI.bpm.value,10) < 120){ UI.bpm.value=124; UI.bpmVal.textContent='124'; } });
UI.speed.addEventListener('change', ()=>{ UI.feelVal.textContent = UI.speed.options[UI.speed.selectedIndex].text; });
UI.reverb.addEventListener('input', ()=> setEffectsFromUI());
UI.dist.addEventListener('input', ()=> setEffectsFromUI());

function setStatus(t, cls=''){ UI.status.textContent = t; UI.status.className = 'pill '+(cls||''); }

// ---------- Sound design ----------
function kick(ctx, t, out){ const o=ctx.createOscillator(); o.type='sine'; const g=ctx.createGain(); g.gain.setValueAtTime(1,t); o.frequency.setValueAtTime(120,t); o.frequency.exponentialRampToValueAtTime(38,t+0.135); g.gain.exponentialRampToValueAtTime(0.0001,t+0.22); o.connect(g).connect(out); o.start(t); o.stop(t+0.26); const click=ctx.createOscillator(); const cg=ctx.createGain(); click.type='square'; click.frequency.setValueAtTime(1000,t); cg.gain.setValueAtTime(0.15,t); cg.gain.exponentialRampToValueAtTime(0.0001,t+0.02); click.connect(cg).connect(out); click.start(t); click.stop(t+0.03); }
function snare(ctx, t, out){ const n=ctx.createBufferSource(); n.buffer=noiseBuffer(ctx); const bp=ctx.createBiquadFilter(); bp.type='bandpass'; bp.frequency.value=1800; bp.Q.value=0.8; const g=ctx.createGain(); g.gain.setValueAtTime(0.65,t); g.gain.exponentialRampToValueAtTime(0.0001,t+0.22); n.connect(bp).connect(g).connect(out); n.start(t); n.stop(t+0.24); }
function hat(ctx, t, out, open=false){ const n=ctx.createBufferSource(); n.buffer=noiseBuffer(ctx); const hp=ctx.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=7000; hp.Q.value=0.7; const g=ctx.createGain(); g.gain.setValueAtTime(open?0.35:0.22,t); g.gain.exponentialRampToValueAtTime(0.0001,t+(open?0.35:0.08)); n.connect(hp).connect(g).connect(out); n.start(t); n.stop(t+(open?0.38:0.1)); }
function clap(ctx,t,out){ const g=ctx.createGain(); g.gain.setValueAtTime(0.5,t); g.gain.exponentialRampToValueAtTime(0.0001,t+0.3); g.connect(out); [0,0.01,0.02].forEach(d=>{ const n=ctx.createBufferSource(); n.buffer=noiseBuffer(ctx); const hp=ctx.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=1800; n.connect(hp).connect(g); n.start(t+d); n.stop(t+0.2+d); }); }
function bass808(ctx, t, out, noteHz, dur=0.5, glide=0){ const o=ctx.createOscillator(); o.type='sine'; const g=ctx.createGain(); const sh=ctx.createWaveShaper(); sh.curve=distCurve(0.9); sh.oversample='4x'; const lp=ctx.createBiquadFilter(); lp.type='lowpass'; lp.frequency.value=3800; o.frequency.setValueAtTime(noteHz*(glide?2:1),t); if(glide){ o.frequency.exponentialRampToValueAtTime(noteHz,t+glide);} g.gain.setValueAtTime(0.0001,t); g.gain.exponentialRampToValueAtTime(0.8,t+0.015); g.gain.exponentialRampToValueAtTime(0.0001,t+dur); o.connect(sh).connect(lp).connect(g).connect(out); o.start(t); o.stop(t+dur+0.05); }
function padChord(ctx, t, out, notes, len){ const g=ctx.createGain(); g.gain.setValueAtTime(0.0,t); g.gain.linearRampToValueAtTime(0.22,t+0.5); g.gain.linearRampToValueAtTime(0.0,t+len); g.connect(out); notes.forEach((hz,i)=>{ const o=ctx.createOscillator(); o.type='triangle'; o.frequency.value=hz; const f=ctx.createBiquadFilter(); f.type='lowpass'; f.frequency.value=1200; o.connect(f).connect(g); o.start(t+0.03*i); o.stop(t+len); }); }
function leadSynth(ctx, t, out, hz, dur=0.35){ const o=ctx.createOscillator(); o.type='sawtooth'; const f=ctx.createBiquadFilter(); f.type='lowpass'; f.frequency.setValueAtTime(600, t); f.frequency.linearRampToValueAtTime(2200, t+0.12); const g=ctx.createGain(); g.gain.setValueAtTime(0.0001,t); g.gain.exponentialRampToValueAtTime(0.5,t+0.02); g.gain.exponentialRampToValueAtTime(0.0001,t+dur); o.frequency.value=hz; o.connect(f).connect(g).connect(out); o.start(t); o.stop(t+dur+0.02); }

// helpers
let _noise=null; function noiseBuffer(ctx){ if(_noise) return _noise; const b=ctx.createBuffer(1,44100,44100); const d=b.getChannelData(0); for(let i=0;i<d.length;i++) d[i]=Math.random()*2-1; _noise=b; return b; }
function distCurve(amount){ const k=Math.max(0.0001,amount)*100; const n=44100; const curve=new Float32Array(n); const deg=Math.PI/180; for(let i=0;i<n;i++){ const x=i*2/n-1; curve[i]=(3+k)*x*20*deg/(Math.PI+k*Math.abs(x)); } return curve; }
function midiToHz(m){ return 440*Math.pow(2,(m-69)/12); }

// ---------- Theory helpers ----------
const SCALES = {
  minorPent: [0,3,5,7,10],           // trap staple
  aeolian:   [0,2,3,5,7,8,10],       // natural minor
  dorian:    [0,2,3,5,7,9,10],       // lo-fi friendly
  houseMix:  [0,2,4,5,7,9,11]        // major/mixolydian feel
};
function buildScale(rootMidi, steps){ return steps.map(s=> rootMidi + s); }
function chordFromScale(scale, degree, type='triad'){ const i=degree%scale.length; const a=scale[i], b=scale[(i+2)%scale.length], c=scale[(i+4)%scale.length]; const d7=scale[(i+6)%scale.length]; return type==='7' ? [a,b,c,d7] : [a,b,c]; }

// Melodic motif generator: prefers chord tones, allows passing tones, occasional octave jumps.
function makeMelody({root=45, scaleSteps=SCALES.minorPent, bars=4, subdivision=2, density=0.55}){
  const scale = buildScale(root, scaleSteps);
  const notes=[]; // {step, midi, len}
  const barLen=16; const stepsTotal=bars*barLen;
  // basic chord progression degrees per bar (i‚ÄìVI‚ÄìVII‚Äìi) style in minor; in house go I‚ÄìIV‚ÄìV‚ÄìI
  const degreesMinor=[0,5,6,0];
  const degreesHouse=[0,3,4,0];
  for(let b=0;b<bars;b++){
    const deg = scaleSteps===SCALES.houseMix ? degreesHouse[b%4] : degreesMinor[b%4];
    const chord = chordFromScale(scale, deg, (scaleSteps===SCALES.houseMix?'7':'triad'));
    for(let s=0;s<barLen; s+=subdivision){
      if(Math.random()<density){
        let pick = (Math.random()<0.7) ? choice(chord) : choice(scale); // favor chord tones
        // passing tone up/down
        if(Math.random()<0.25){ pick += Math.random()<0.5? 1 : -1; }
        // octave jump spice
        if(Math.random()<0.12){ pick += Math.random()<0.5? 12 : -12; }
        const len = (Math.random()<0.3)? 0.75 : 0.5; // some ties
        notes.push({ step: b*barLen + s, midi: pick, len });
      }
    }
  }
  return notes;
}

// ---------- Pattern generation (genre‚Äëaware) ----------
function generatePattern(cfg){
  const { bpm, genre, influence, speed } = cfg;
  const bar=16, bars=4, steps=bar*bars; const pat={ bpm, steps, notes:[], hats:[], openh:[], kicks:[], snares:[], claps:[], pads:[], leads:[] };

  // Genre defaults
  const isHouse = genre==='house';
  // drums
  for(let b=0;b<bars;b++){
    if(isHouse){ // four-on-the-floor
      [0,4,8,12].forEach(off=> pat.kicks.push(b*bar+off));
      pat.snares.push(b*bar+8); // clap/snare on 2/4
      pat.claps.push(b*bar+8);
      [2,6,10,14].forEach(off=> pat.openh.push(b*bar+off)); // offbeat open hats
      for(let s=0;s<bar;s++){ if(s%2===0) pat.hats.push(b*bar+s); }
    } else {
      const extraClapProb = genre==='drill'? 0.28 : 0.15;
      const hatDensity = influence==='club'?0.9 : influence==='classic'?0.75 : 0.85;
      const hatRollProb = speed==='triplet'? 0.6 : 0.35;
      for(let s=0;s<bar;s++){
        if(s===0) pat.kicks.push(b*bar+s);
        if(Math.random() < (genre==='drill'?0.26:0.18)) pat.kicks.push(b*bar + s + (Math.random()<0.5?2:4));
        if(Math.random()<0.08) pat.kicks.push(b*bar + s + 1);
        if(Math.random() < hatDensity * ((s%2)?1:0.85)) pat.hats.push(b*bar + s);
        if(Math.random() < hatRollProb && s%4===0){ pat.hats.push(b*bar+s+0.5); if(speed!=='half') pat.hats.push(b*bar+s+0.75); if(speed==='triplet'){ pat.hats.push(b*bar+s+0.33); pat.hats.push(b*bar+s+0.66);} }
        if(Math.random()< (influence==='spacey'?0.22:0.12) && s>4) pat.openh.push(b*bar + s + (Math.random()<0.5?0:1));
      }
      pat.snares.push(b*bar+8); if(Math.random()<extraClapProb) pat.claps.push(b*bar+6);
    }
  }

  // Harmony & melody
  const root = isHouse? 48 : 45; // C3 for house, A2 for trap family
  const scaleSteps = isHouse? SCALES.houseMix : (genre==='lofi'? SCALES.dorian : SCALES.minorPent);
  // pads
  const chordsMinor=[[45,52,57],[48,55,60],[50,57,62],[52,59,64]]; // A‚Äë, C, D, E
  const chordsHouse=[[48,52,55,60],[50,54,57,62],[52,55,59,64],[48,52,55,60]]; // Cmaj7-ish cycle
  for(let b=0;b<bars;b++){ const chord = (isHouse? chordsHouse: chordsMinor)[b%4].map(m=> midiToHz(m)); pat.pads.push({ bar:b, chord }); }
  // bass lines
  const bassBeats = isHouse? [0,4,8,12] : [0,4,8,12];
  bassBeats.forEach((off,bidx)=>{ const m = (isHouse? 36: 45) + (isHouse? 0 : (Math.random()<0.3? -12:0)); pat.notes.push({ step: off, midi:m, len: isHouse? 0.95 : 0.6, glide: 0 }); });
  // melodic lead with theory
  pat.leads = makeMelody({ root: root, scaleSteps, bars, subdivision: (isHouse? 4 : 2), density: (isHouse? 0.45:0.6) });

  return pat;
}

// ---------- Sequencer ----------
function startPlayback(){
  ensureAudio(); if(nowPlaying) return; nowPlaying=true; setStatus('Playing','ok');
  const bpm=parseFloat(UI.bpm.value); const spb=60/bpm; const stepDur=spb/4; const swingAmt=(parseFloat(UI.swing.value)||0)/100 * 0.6; const start=audio.currentTime+0.05; const out=bus;
  let stepIdx=0; const total=pattern.steps; let nextTime=start;
  function scheduler(){ const ahead=0.15; while(nextTime < audio.currentTime + ahead){ const s=stepIdx % total; const swingOffset=(s%2===1)? swingAmt*stepDur : 0; const tBase = nextTime + swingOffset;
      if(pattern.kicks.includes(s)) kick(audio,tBase,out);
      if(pattern.snares.includes(s)) snare(audio,tBase,out);
      if(pattern.claps.includes(s)) clap(audio,tBase+0.02,out);
      pattern.hats.forEach(h=>{ const base=Math.floor(h); const frac=h%1; if(base===s){ hat(audio, tBase + frac*stepDur, out, false); }});
      if(pattern.openh.includes(s)) hat(audio,tBase,out,true);
      pattern.notes.forEach(n=>{ if(n.step===s){ const hz=midiToHz(n.midi); bass808(audio,tBase,out,hz,n.len,n.glide||0); }});
      // leads start on step boundaries
      pattern.leads.forEach(n=>{ if(n.step===s){ leadSynth(audio, tBase, out, midiToHz(n.midi+(UI.genre.value==='house'?12:0)), n.len*stepDur*4); }});
      // pads per bar
      if(s%16===0){ const bar=Math.floor(s/16); const p=pattern.pads.find(x=>x.bar===bar); if(p){ padChord(audio, tBase, out, p.chord, 16*stepDur); }}
      stepIdx++; nextTime += stepDur; }
    scheduleTimer=setTimeout(scheduler,25); }
  scheduler();
}
function stopPlayback(){ if(!audio) return; nowPlaying=false; clearTimeout(scheduleTimer); setStatus('Stopped'); }

// ---------- Render to WAV ----------
async function renderWav(){ setStatus('Rendering‚Ä¶'); UI.btnRender.disabled=true; const bpm=parseFloat(UI.bpm.value); const spb=60/bpm; const stepDur=spb/4; const swingAmt=(parseFloat(UI.swing.value)||0)/100*0.6; const lengthSec=pattern.steps*stepDur+0.9; const rate=44100; const off=new OfflineAudioContext(2, Math.ceil(lengthSec*rate), rate);
  // FX
  const busO=off.createGain(); const distO=off.createWaveShaper(); distO.curve=distCurve((parseFloat(UI.dist.value)||0)/100); distO.oversample='4x'; const dryO=off.createGain(); dryO.gain.value=0.9*(1-(parseFloat(UI.reverb.value)||0)/100); const convO=off.createConvolver(); convO.buffer=makeImpulse(off,2.2,2.5); const revO=off.createGain(); revO.gain.value=(parseFloat(UI.reverb.value)||0)/100; const masterO=off.createGain(); masterO.gain.value=0.9; busO.connect(distO); distO.connect(dryO); dryO.connect(masterO); busO.connect(convO); convO.connect(revO); revO.connect(masterO); masterO.connect(off.destination);
  const start=0.02, step=stepDur; for(let s=0;s<pattern.steps;s++){ const swingOffset=(s%2===1)? swingAmt*step:0; const t=start+s*step+swingOffset; if(pattern.kicks.includes(s)) kick(off,t,busO); if(pattern.snares.includes(s)) snare(off,t,busO); if(pattern.claps.includes(s)) clap(off,t+0.02,busO); pattern.hats.forEach(h=>{ const base=Math.floor(h); const frac=h%1; if(base===s){ hat(off,t+frac*step,busO,false); }}); if(pattern.openh.includes(s)) hat(off,t,busO,true); pattern.notes.forEach(n=>{ if(n.step===s){ const hz=midiToHz(n.midi); bass808(off,t,busO,hz,n.len,n.glide||0); }}); pattern.leads.forEach(n=>{ if(n.step===s){ leadSynth(off,t,busO,midiToHz(n.midi+(UI.genre.value==='house'?12:0)), n.len*step); }}); if(s%16===0){ const bar=Math.floor(s/16); const p=pattern.pads.find(x=>x.bar===bar); if(p){ padChord(off,t,busO,p.chord,16*step); }} }
  const buf=await off.startRendering(); const wav=audioBufferToWav(buf); const blob=new Blob([wav],{type:'audio/wav'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`traplab_${Date.now()}.wav`; a.click(); setTimeout(()=>URL.revokeObjectURL(url),1500); setStatus('Rendered ‚úì','ok'); UI.btnRender.disabled=false; }

function audioBufferToWav(buffer){ const num=buffer.numberOfChannels; const len=buffer.length*num*2+44; const out=new ArrayBuffer(len); const view=new DataView(out); const ch=[]; let offst=0,pos=0; set32(0x46464952); set32(len-8); set32(0x45564157); set32(0x20746d66); set32(16); set16(1); set16(num); set32(buffer.sampleRate); set32(buffer.sampleRate*num*2); set16(num*2); set16(16); set32(0x61746164); set32(len-44); for(let i=0;i<num;i++) ch.push(buffer.getChannelData(i)); while(pos<buffer.length){ for(let i=0;i<num;i++){ let s=Math.max(-1,Math.min(1,ch[i][pos])); view.setInt16(44+(pos*num+i)*2, s<0? s*0x8000: s*0x7FFF, true); } pos++; } return out; function set16(d){ view.setUint16(offst,d,true); offst+=2;} function set32(d){ view.setUint32(offst,d,true); offst+=4;}}

// ---------- FX, Viz ----------
function setEffectsFromUI(){ if(!audio) return; const mix=(parseFloat(UI.reverb.value)||0)/100; revGain.gain.value=mix; dryGain.gain.value=0.9*(1-mix); const amt=(parseFloat(UI.dist.value)||0)/100; distWS.curve=distCurve(amt); }
function makeImpulse(ctx, seconds=2.0, decay=2.0){ const rate=ctx.sampleRate; const len=Math.floor(rate*seconds); const impulse=ctx.createBuffer(2,len,rate); for(let ch=0; ch<2; ch++){ const data=impulse.getChannelData(ch); for(let i=0;i<len;i++){ data[i]=(Math.random()*2-1)*Math.pow(1 - i/len, decay); } } return impulse; }
function startViz(){ const c=$('#viz'); if(!c) return; const ctx=c.getContext('2d'); const dpr=window.devicePixelRatio||1; const fit=()=>{ const r=c.getBoundingClientRect(); c.width=r.width*dpr; c.height=r.height*dpr; }; fit(); window.addEventListener('resize', fit); const data=new Uint8Array(analyser.frequencyBinCount); (function draw(){ if(!analyser){ requestAnimationFrame(draw); return;} analyser.getByteTimeDomainData(data); const w=c.width,h=c.height; ctx.clearRect(0,0,w,h); const cx=w/2,cy=h/2; const base=Math.min(w,h)/2 - 8*dpr; let sum=0; for(let i=0;i<data.length;i++){ const v=(data[i]-128)/128; sum += Math.abs(v);} const avg=sum/data.length; const radius = base*(0.9 + avg*0.22); ctx.beginPath(); ctx.arc(cx,cy,radius,0,Math.PI*2); ctx.strokeStyle='rgba(27,106,255,0.85)'; ctx.lineWidth=3*dpr; ctx.stroke(); requestAnimationFrame(draw); })(); }

// ---------- UI actions ----------
UI.btnGen.addEventListener('click', ()=>{ ensureAudio(); const cfg={ bpm: parseFloat(UI.bpm.value), genre: UI.genre.value, influence: UI.influence.value, speed: UI.speed.value }; pattern=generatePattern(cfg); setStatus('Pattern ‚úì','ok'); UI.btnPlay.disabled=false; UI.btnRender.disabled=false; UI.btnStop.disabled=false; $('#genHint').textContent = `${UI.genre.options[UI.genre.selectedIndex].text}`; });
UI.btnPlay.addEventListener('click', startPlayback);
UI.btnStop.addEventListener('click', ()=> stopPlayback());
UI.btnRender.addEventListener('click', ()=>{ if(pattern) renderWav(); });
</script>
</body>
</html>
