<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Trap Lab ‚Äî generate smooth trap beats (mobile‚Äëfirst)</title>
<meta name="description" content="Tap the circle to generate a trap beat. Choose BPM, genre, influence, and speed. Play instantly, tweak swing/reverb/distortion, visualize, and download as WAV ‚Äî all in your browser." />
<style>
  :root{
    --bg:#0a0c14; --panel:#0f1220; --ink:#e8ebff; --muted:#a7afff; --line:#1b2242;
    --accent:#6ae3ff; --good:#22c55e; --warn:#f59e0b; --bad:#ef4444;
  }
  *{box-sizing:border-box}
  body{margin:0;background:radial-gradient(900px 420px at 80% -10%,#1b2450,transparent),linear-gradient(180deg,#090c18,#0e1224);color:var(--ink);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
  header{position:sticky;top:0;z-index:5;background:rgba(10,12,20,.82);backdrop-filter:blur(8px) saturate(120%);border-bottom:1px solid var(--line)}
  .wrap{max-width:980px;margin:0 auto;padding:1rem}
  h1{margin:.2rem 0 .2rem;font-size:1.08rem}
  main{max-width:980px;margin:0 auto;padding:1rem;display:grid;gap:1rem}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:1rem}

  /* Center circle */
  .stage{display:grid;place-items:center;min-height:320px}
  .circle{--sz:min(78vw,520px);width:var(--sz);height:var(--sz);border-radius:50%;position:relative;background:conic-gradient(from 90deg,#11173a,#0e1533 40%,#0f1b48 60%,#0e1533);box-shadow:inset 0 0 80px rgba(0,0,0,.55),0 20px 60px rgba(0,0,0,.35);border:1px solid #1c2550}
  #viz{position:absolute;inset:8%;width:84%;height:84%;pointer-events:none}
  .ring{position:absolute;inset:10%;border-radius:50%;border:1px dashed #2a3572}
  .pulse{position:absolute;inset:0;border-radius:50%;filter:blur(14px);opacity:.35;animation:pulse 2.4s ease-in-out infinite}
  @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(106,227,255,.25)}70%{box-shadow:0 0 0 28px rgba(106,227,255,.0)}100%{box-shadow:0 0 0 0 rgba(106,227,255,.0)}}
  .center{position:absolute;inset:22%;border-radius:50%;display:grid;place-items:center;background:radial-gradient(120px 120px at 60% 30%,#24336e,#151b3d 35%,#0f132c);border:1px solid #27316a}
  .center button{all:unset;display:grid;place-items:center;width:140px;height:140px;border-radius:50%;background:linear-gradient(180deg,#2a3777,#223067);border:1px solid #3a4686;cursor:pointer;box-shadow:0 10px 25px rgba(0,0,0,.35)}
  .center button:active{transform:scale(.98)}
  .btnLabel{font-weight:700}
  .sub{font-size:.82rem;color:var(--muted)}

  .chips{display:flex;flex-wrap:wrap;gap:.5rem;justify-content:center;margin-top:.6rem}
  .chip{display:inline-flex;align-items:center;gap:.45rem;border:1px solid #2b3563;background:#0f1639;border-radius:999px;padding:.28rem .6rem}
  .chip input[type=range]{width:120px}
  .chip select{background:transparent;color:var(--ink);border:0;outline:0}

  .row{display:grid;grid-template-columns:1fr 1fr;gap:.6rem}
  @media (max-width:700px){.row{grid-template-columns:1fr}}
  button{background:#223067;border:1px solid #334186;color:#fff;border-radius:10px;padding:.55rem .85rem;cursor:pointer}
  button[disabled]{opacity:.6;cursor:not-allowed}
  .pill{display:inline-flex;align-items:center;gap:.35rem;border:1px solid #334186;background:#0f1639;padding:.25rem .6rem;border-radius:999px;font-size:.85rem}
  .ok{color:var(--good)}.warn{color:var(--warn)}.bad{color:var(--bad)}

  .footer{opacity:.75;font-size:.9rem}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>üéõÔ∏è Trap Lab ‚Äî pocket beat generator</h1>
    <div class="sub">Tap the circle to generate a beat. Tweak BPM, vibe, speed, swing, reverb, and distortion. Play instantly and download as WAV ‚Äî works offline after load.</div>
  </div>
</header>

<main>
  <section class="card stage">
    <div class="circle" id="circle">
      <canvas id="viz"></canvas>
      <div class="pulse"></div>
      <div class="ring"></div>
      <div class="center">
        <button id="btnGen">
          <div class="btnLabel">Generate</div>
          <div class="sub" id="genHint">new pattern</div>
        </button>
      </div>
    </div>
    <div class="chips">
      <span class="chip">BPM <input id="bpm" type="range" min="60" max="180" value="140"><span id="bpmVal">140</span></span>
      <span class="chip">Genre
        <select id="genre">
          <option value="trap" selected>Trap</option>
          <option value="drill">Drill</option>
          <option value="lofi">Lo‚Äëfi Trap</option>
        </select>
      </span>
      <span class="chip">Influence
        <select id="influence">
          <option value="classic" selected>Classic</option>
          <option value="dark">Dark</option>
          <option value="spacey">Spacey</option>
          <option value="club">Club</option>
        </select>
      </span>
      <span class="chip">Speed
        <select id="speed">
          <option value="1x" selected>1√ó</option>
          <option value="half">Half‚Äëtime</option>
          <option value="triplet">Triplet</option>
        </select>
      </span>
    </div>
    <div class="chips">
      <span class="chip">Swing <input id="swing" type="range" min="0" max="60" value="0"><span id="swingVal">0%</span></span>
      <span class="chip">Reverb <input id="reverb" type="range" min="0" max="100" value="20"><span id="reverbVal">20%</span></span>
      <span class="chip">Distortion <input id="dist" type="range" min="0" max="100" value="10"><span id="distVal">10%</span></span>
    </div>
    <div class="chips">
      <button id="btnPlay" disabled>‚ñ∂ Play</button>
      <button id="btnStop" disabled>‚ñ† Stop</button>
      <button id="btnRender" disabled>‚¨á Download WAV</button>
      <span id="status" class="pill">Ready</span>
    </div>
  </section>

  <section class="card footer">
    <strong>Heads‚Äëup:</strong> Audio is synthesized in your browser with the Web Audio API. Rendering to WAV uses an OfflineAudioContext and can take a few seconds, depending on your phone.
  </section>
</main>

<script>
// ----- Utility / random -----
const $ = (s)=> document.querySelector(s);
const rnd = (a,b)=> a + Math.random()*(b-a);
const choice = (arr)=> arr[Math.floor(Math.random()*arr.length)];

// ----- State -----
let audio = null; // live context
let master = null;
let analyser = null;
let bus = null; // pre-FX bus
let dryGain = null, revGain = null, revConvolver = null, distWS = null;
let nowPlaying = false;
let scheduleTimer = null;
let pattern = null; // generated pattern
let seed = Math.random()*1e9|0;

const UI = {
  bpm: $('#bpm'), bpmVal: $('#bpmVal'),
  genre: $('#genre'), influence: $('#influence'), speed: $('#speed'),
  swing: $('#swing'), swingVal: $('#swingVal'),
  reverb: $('#reverb'), reverbVal: $('#reverbVal'),
  dist: $('#dist'), distVal: $('#distVal'),
  btnGen: $('#btnGen'), btnPlay: $('#btnPlay'), btnStop: $('#btnStop'), btnRender: $('#btnRender'),
  status: $('#status'), hint: $('#genHint')
};

UI.bpm.addEventListener('input', ()=> UI.bpmVal.textContent = UI.bpm.value);
UI.swing.addEventListener('input', ()=>{ UI.swingVal.textContent = UI.swing.value+'%'; setEffectsFromUI(); });
UI.reverb.addEventListener('input', ()=>{ UI.reverbVal.textContent = UI.reverb.value+'%'; setEffectsFromUI(); });
UI.dist.addEventListener('input', ()=>{ UI.distVal.textContent = UI.dist.value+'%'; setEffectsFromUI(); });

function setStatus(t, cls=''){ UI.status.textContent = t; UI.status.className = 'pill '+(cls||''); }

function ensureAudio(){
  if(audio) return audio;
  audio = new (window.AudioContext || window.webkitAudioContext)();
  // FX graph
  bus = audio.createGain(); bus.gain.value = 1.0;
  distWS = audio.createWaveShaper(); distWS.curve = distCurve(0.1); distWS.oversample='4x';
  dryGain = audio.createGain(); dryGain.gain.value = 0.9;
  revConvolver = audio.createConvolver(); revConvolver.buffer = makeImpulse(audio, 2.2, 2.5);
  revGain = audio.createGain(); revGain.gain.value = 0.2;
  master = audio.createGain(); master.gain.value = 0.9;
  analyser = audio.createAnalyser(); analyser.fftSize = 256;
  // Routing
  bus.connect(distWS); distWS.connect(dryGain); dryGain.connect(master);
  bus.connect(revConvolver); revConvolver.connect(revGain); revGain.connect(master);
  master.connect(audio.destination);
  master.connect(analyser);
  setEffectsFromUI();
  startViz();
  return audio;
}

// ---------- Sound design ----------
function kick(ctx, t, out){
  const o = ctx.createOscillator(); o.type='sine';
  const g = ctx.createGain(); g.gain.setValueAtTime(1, t);
  o.frequency.setValueAtTime(120, t);
  o.frequency.exponentialRampToValueAtTime(38, t+0.135);
  g.gain.exponentialRampToValueAtTime(0.0001, t+0.22);
  o.connect(g).connect(out); o.start(t); o.stop(t+0.26);
  const click = ctx.createOscillator(); const cg = ctx.createGain();
  click.type='square'; click.frequency.setValueAtTime(1000, t);
  cg.gain.setValueAtTime(0.15, t); cg.gain.exponentialRampToValueAtTime(0.0001, t+0.02);
  click.connect(cg).connect(out); click.start(t); click.stop(t+0.03);
}
function snare(ctx, t, out){
  const noise = noiseBuffer(ctx); const n = ctx.createBufferSource(); n.buffer = noise;
  const bp = ctx.createBiquadFilter(); bp.type='bandpass'; bp.frequency.value=1800; bp.Q.value=0.8;
  const g = ctx.createGain(); g.gain.setValueAtTime(0.65, t); g.gain.exponentialRampToValueAtTime(0.0001, t+0.22);
  n.connect(bp).connect(g).connect(out); n.start(t); n.stop(t+0.24);
}
function hat(ctx, t, out, open=false){
  const noise = noiseBuffer(ctx); const n = ctx.createBufferSource(); n.buffer = noise;
  const hp = ctx.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=7000; hp.Q.value=0.7;
  const g = ctx.createGain(); g.gain.setValueAtTime( open?0.35:0.22, t);
  g.gain.exponentialRampToValueAtTime(0.0001, t + (open?0.35:0.08));
  n.connect(hp).connect(g).connect(out); n.start(t); n.stop(t + (open?0.38:0.1));
}
function clap(ctx,t,out){
  const g = ctx.createGain(); g.gain.setValueAtTime(0.5,t); g.gain.exponentialRampToValueAtTime(0.0001,t+0.3); g.connect(out);
  [0,0.01,0.02].forEach((d)=>{ const n=ctx.createBufferSource(); n.buffer=noiseBuffer(ctx); const hp=ctx.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=1800; n.connect(hp).connect(g); n.start(t+d); n.stop(t+0.2+d); });
}
function bass808(ctx, t, out, noteHz, dur=0.5, glide=0){
  const o = ctx.createOscillator(); o.type='sine';
  const g = ctx.createGain(); const sh=ctx.createWaveShaper(); sh.curve=distCurve(0.9); sh.oversample='4x';
  const lp = ctx.createBiquadFilter(); lp.type='lowpass'; lp.frequency.value=3800;
  o.frequency.setValueAtTime(noteHz*(glide?2:1), t);
  if(glide){ o.frequency.exponentialRampToValueAtTime(noteHz, t+glide); }
  g.gain.setValueAtTime(0.0001,t); g.gain.exponentialRampToValueAtTime(0.8,t+0.015); g.gain.exponentialRampToValueAtTime(0.0001, t+dur);
  o.connect(sh).connect(lp).connect(g).connect(out); o.start(t); o.stop(t+dur+0.05);
}
function padChord(ctx, t, out, notes, len){
  const g=ctx.createGain(); g.gain.setValueAtTime(0.0,t); g.gain.linearRampToValueAtTime(0.22,t+0.5); g.gain.linearRampToValueAtTime(0.0,t+len);
  g.connect(out);
  notes.forEach((hz,i)=>{ const o=ctx.createOscillator(); o.type='triangle'; o.frequency.value=hz; const f=ctx.createBiquadFilter(); f.type='lowpass'; f.frequency.value=1200; o.connect(f).connect(g); o.start(t+0.03*i); o.stop(t+len); });
}

// helpers
let _noise=null; function noiseBuffer(ctx){ if(_noise) return _noise; const b=ctx.createBuffer(1, 44100, 44100); const d=b.getChannelData(0); for(let i=0;i<d.length;i++){ d[i]=Math.random()*2-1; } _noise=b; return b; }
function distCurve(amount){ const k=Math.max(0.0001, amount)*100; const n=44100; const curve=new Float32Array(n); const deg=Math.PI/180; for(let i=0;i<n;i++){ const x=i*2/n-1; curve[i]=(3+k)*x*20*deg/(Math.PI+k*Math.abs(x)); } return curve; }
function midiToHz(m){ return 440*Math.pow(2, (m-69)/12); }

// ---------- Pattern generation ----------
function generatePattern({bpm, genre, influence, speed}){
  seed = (seed*1664525 + 1013904223) % 0x100000000; // LCG
  const rndSeeded = ()=> ((seed = (seed*1664525 + 1013904223)>>>0) / 0x100000000);
  const bar = 16; // 16 steps per bar
  const bars = 4; // 4 bars
  const steps = bar*bars; // 64

  const hatDensity = influence==='club'? 0.9 : influence==='classic'? 0.75 : 0.85;
  const hatRollProb = speed==='triplet'? 0.6 : 0.35;
  const openHatProb = influence==='spacey'? 0.22 : 0.12;
  const extraClapProb = genre==='drill'? 0.28 : 0.15;

  const pat = { bpm, steps, notes:[], hats:[], openh:[], kicks:[], snares:[], claps:[], pads:[] };
  for(let b=0;b<bars;b++){ const sn = b*bar + 8; pat.snares.push(sn); if(rndSeeded()<extraClapProb){ pat.claps.push(sn-2); } }

  for(let s=0;s<steps;s++){
    if(s%bar===0) pat.kicks.push(s);
    if(rndSeeded()< (genre==='drill'?0.26:0.18)) pat.kicks.push(s + (rndSeeded()<0.5?2:4));
    if(rndSeeded()<0.08) pat.kicks.push(s+1);
  }

  for(let s=0;s<steps;s++){
    if(rndSeeded() < hatDensity*( (s%2)?1:0.85 )) pat.hats.push(s);
    if(rndSeeded() < openHatProb && s%bar>4) pat.openh.push(s+ (rndSeeded()<0.5?0:1));
    if(rndSeeded() < hatRollProb && s%4===0){ pat.hats.push(s+0.5); if(speed!=='half'){ pat.hats.push(s+0.75); }
      if(speed==='triplet'){ pat.hats.push(s+0.33); pat.hats.push(s+0.66); }
    }
  }

  const scale = [45,48,50,52,55]; // MIDI
  for(let b=0;b<bars;b++){
    const root = choice(scale);
    for(let s=0;s<bar;s+=4){
      const m = (rndSeeded()<0.6? root : choice(scale));
      const step = b*bar + s + (rndSeeded()<0.3?1:0);
      pat.notes.push({ step, midi:m, len: (genre==='drill'? rnd(0.4,0.9): rnd(0.25,0.6)), glide: (genre==='drill' && rndSeeded()<0.5)? 0.08: 0 });
    }
  }

  const chords = [ [45,52,57], [48,55,60], [50,57,62], [52,59,64] ];
  for(let b=0;b<bars;b++){ pat.pads.push({ bar:b, chord: chords[b%chords.length] }); }

  return pat;
}

// ---------- Sequencer ----------
function startPlayback(){
  ensureAudio(); if(nowPlaying) return; nowPlaying=true; setStatus('Playing', 'ok');
  const bpm = parseFloat(UI.bpm.value);
  const spb = 60/bpm; // quarter
  const stepDur = spb/4; // 16th
  const swingAmt = (parseFloat(UI.swing.value)||0)/100 * 0.6; // up to 60% of 16th
  const start = audio.currentTime + 0.05;
  const out = bus;

  let stepIdx = 0; const total = pattern.steps; let nextTime = start;
  function scheduler(){
    const ahead = 0.15;
    while(nextTime < audio.currentTime + ahead){
      const s = stepIdx % total;
      const swingOffset = (s%2===1) ? swingAmt*stepDur : 0;
      const tBase = nextTime + swingOffset;
      if(pattern.kicks.includes(s)) kick(audio, tBase, out);
      if(pattern.snares.includes(s)) snare(audio, tBase, out);
      if(pattern.claps.includes(s)) clap(audio, tBase+0.02, out);
      pattern.hats.forEach(h=>{ const base=Math.floor(h); const frac=h%1; if(base===s){ hat(audio, tBase + frac*stepDur, out, false); }});
      if(pattern.openh.includes(s)) hat(audio, tBase, out, true);
      pattern.notes.forEach(n=>{ if(n.step===s){ const hz=midiToHz(n.midi); bass808(audio, tBase, out, hz, n.len, n.glide); }});
      if(s%16===0){ const bar=Math.floor(s/16); const p=pattern.pads.find(x=>x.bar===bar); if(p){ padChord(audio, tBase, out, p.chord.map(midiToHz), 16*stepDur); }}
      stepIdx++; nextTime += stepDur;
    }
    scheduleTimer = setTimeout(scheduler, 25);
  }
  scheduler();
}
function stopPlayback(){ if(!audio) return; nowPlaying=false; clearTimeout(scheduleTimer); setStatus('Stopped'); }

// ---------- Render to WAV ----------
async function renderWav(){
  setStatus('Rendering‚Ä¶'); UI.btnRender.disabled=true;
  const bpm = parseFloat(UI.bpm.value); const spb=60/bpm; const stepDur=spb/4; const swingAmt=(parseFloat(UI.swing.value)||0)/100 * 0.6;
  const lengthSec = pattern.steps*stepDur + 0.7;
  const rate = 44100; const off = new OfflineAudioContext(2, Math.ceil(lengthSec*rate), rate);
  const busO = off.createGain();
  const distO = off.createWaveShaper(); distO.curve = distCurve((parseFloat(UI.dist.value)||0)/100); distO.oversample='4x';
  const dryO = off.createGain(); dryO.gain.value = 0.9 * (1 - (parseFloat(UI.reverb.value)||0)/100);
  const convO = off.createConvolver(); convO.buffer = makeImpulse(off, 2.2, 2.5);
  const revO = off.createGain(); revO.gain.value = (parseFloat(UI.reverb.value)||0)/100;
  const masterO = off.createGain(); masterO.gain.value = 0.9;
  busO.connect(distO); distO.connect(dryO); dryO.connect(masterO);
  busO.connect(convO); convO.connect(revO); revO.connect(masterO);
  masterO.connect(off.destination);

  const start=0.02; const step=stepDur; for(let s=0;s<pattern.steps;s++){
    const swingOffset = (s%2===1) ? swingAmt*step : 0; const t = start + s*step + swingOffset;
    if(pattern.kicks.includes(s)) kick(off, t, busO);
    if(pattern.snares.includes(s)) snare(off, t, busO);
    if(pattern.claps.includes(s)) clap(off, t+0.02, busO);
    pattern.hats.forEach(h=>{ const base=Math.floor(h); const frac=h%1; if(base===s){ hat(off, t + frac*step, busO, false); }});
    if(pattern.openh.includes(s)) hat(off, t, busO, true);
    pattern.notes.forEach(n=>{ if(n.step===s){ const hz=midiToHz(n.midi); bass808(off, t, busO, hz, n.len, n.glide); }});
    if(s%16===0){ const bar=Math.floor(s/16); const p=pattern.pads.find(x=>x.bar===bar); if(p){ padChord(off, t, busO, p.chord.map(midiToHz), 16*step); }}
  }
  const buf = await off.startRendering();
  const wav = audioBufferToWav(buf);
  const blob = new Blob([wav], {type:'audio/wav'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download=`traplab_${Date.now()}.wav`; a.click(); setTimeout(()=> URL.revokeObjectURL(url), 1500);
  setStatus('Rendered ‚úì', 'ok'); UI.btnRender.disabled=false;
}

function audioBufferToWav(buffer){
  const numOfChan = buffer.numberOfChannels; const length = buffer.length * numOfChan * 2 + 44; const out = new ArrayBuffer(length); const view = new DataView(out);
  const channels = []; let offset = 0; let pos = 0;
  setUint32(0x46464952); setUint32(length-8); setUint32(0x45564157); setUint32(0x20746d66); setUint32(16); setUint16(1); setUint16(numOfChan); setUint32(buffer.sampleRate); setUint32(buffer.sampleRate * numOfChan * 2); setUint16(numOfChan * 2); setUint16(16); setUint32(0x61746164); setUint32(length - 44);
  for(let i=0;i<numOfChan;i++) channels.push(buffer.getChannelData(i));
  while(pos < buffer.length){ for(let i=0;i<numOfChan;i++){ let sample = Math.max(-1, Math.min(1, channels[i][pos])); view.setInt16(44 + (pos*numOfChan + i)*2, sample < 0 ? sample*0x8000 : sample*0x7FFF, true); } pos++; }
  return out;
  function setUint16(d){ view.setUint16(offset, d, true); offset+=2; }
  function setUint32(d){ view.setUint32(offset, d, true); offset+=4; }
}

// ---------- UI actions ----------
UI.btnGen.addEventListener('click', ()=>{
  ensureAudio();
  const cfg = { bpm: parseFloat(UI.bpm.value), genre: UI.genre.value, influence: UI.influence.value, speed: UI.speed.value };
  pattern = generatePattern(cfg);
  setStatus('Pattern ready ‚úì','ok'); UI.btnPlay.disabled=false; UI.btnRender.disabled=false; UI.btnStop.disabled=false; UI.hint.textContent = `${cfg.genre}, ${cfg.influence}`;
});
UI.btnPlay.addEventListener('click', startPlayback);
UI.btnStop.addEventListener('click', ()=>{ stopPlayback(); });
UI.btnRender.addEventListener('click', ()=>{ if(pattern) renderWav(); });

// iOS unlock touch
window.addEventListener('touchstart', ()=>{ if(audio && audio.state==='suspended') audio.resume(); }, {passive:true});

function setEffectsFromUI(){ if(!audio) return; const mix=(parseFloat(UI.reverb.value)||0)/100; revGain.gain.value = mix; dryGain.gain.value = 0.9*(1-mix); const amt=(parseFloat(UI.dist.value)||0)/100; distWS.curve = distCurve(amt); }

function makeImpulse(ctx, seconds=2.0, decay=2.0){ const rate=ctx.sampleRate; const len=Math.floor(rate*seconds); const impulse=ctx.createBuffer(2,len,rate); for(let ch=0; ch<2; ch++){ const data=impulse.getChannelData(ch); for(let i=0;i<len;i++){ data[i]=(Math.random()*2-1)*Math.pow(1 - i/len, decay); } } return impulse; }

// ---------- Visualizer ----------
function startViz(){ const c=$('#viz'); if(!c) return; const ctx=c.getContext('2d'); const dpr=window.devicePixelRatio||1; const fit=()=>{ const r=c.getBoundingClientRect(); c.width=r.width*dpr; c.height=r.height*dpr; }; fit(); window.addEventListener('resize', fit);
  const data = new Uint8Array(analyser.frequencyBinCount);
  function draw(){ if(!analyser){ requestAnimationFrame(draw); return; } analyser.getByteTimeDomainData(data); const w=c.width, h=c.height; ctx.clearRect(0,0,w,h); const cx=w/2, cy=h/2; const base=Math.min(w,h)/2 - 6*dpr; let sum=0; for(let i=0;i<data.length;i++){ const v=(data[i]-128)/128; sum += Math.abs(v); }
    const avg = sum/data.length; const radius = base*(0.92 + avg*0.2);
    ctx.beginPath(); ctx.arc(cx, cy, radius, 0, Math.PI*2); ctx.strokeStyle='rgba(106,227,255,0.85)'; ctx.lineWidth=3*dpr; ctx.stroke();
    requestAnimationFrame(draw);
  }
  draw(); }
</script>
</body>
</html>
